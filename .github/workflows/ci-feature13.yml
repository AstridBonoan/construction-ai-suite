name: CI â€” Feature 13

on:
  push:
    branches: [ feature/customer-saas-frontend-v1 ]
  pull_request:
    branches: [ main ]

jobs:
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install frontend deps
        working-directory: frontend
        run: |
          if [ -f package-lock.json ]; then npm ci --legacy-peer-deps; else npm install --legacy-peer-deps; fi
      - name: Build frontend
        working-directory: frontend
        run: |
          npm run build
      - name: Run frontend lint
        working-directory: frontend
        run: |
          npm run lint || true
      - name: Install Playwright browsers
        working-directory: frontend
        run: npm run e2e:install || true
      - name: Run E2E tests (smoke)
        working-directory: frontend
        run: npm run e2e || true
  backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d testdb" --health-interval=5s --health-timeout=5s --health-retries=5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb
    steps:
      - uses: actions/checkout@v4
      - name: Wait for Postgres
        run: |
          timeout 30 bash -c "until pg_isready -h localhost -p 5432; do sleep 1; done"
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
      - name: Apply SQL migrations
        run: |
          python backend/app/scripts/run_migrations.py
      - name: Initialize DB (create_all) for tests (dev fallback)
        run: |
          python backend/app/scripts/init_db.py || true
      - name: Run backend tests
        run: |
          pytest tests/backend -q
      - name: Run backend lint (placeholder)
        run: echo "Run backend linters as needed"
